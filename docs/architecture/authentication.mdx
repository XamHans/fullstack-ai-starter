---
title: "Authentication"
description: "Authentication implementation using better-auth with email/password and OAuth providers, session management, and security best practices."
---

# Authentication & Security

We use better-auth library for handling authentication and authorization.

### Better Auth Implementation (2025 Best Practices)

#### 1. Better Auth Configuration

```typescript
// lib/auth.ts
import { betterAuth } from 'better-auth';
import { drizzleAdapter } from 'better-auth/adapters/drizzle';
import { nextCookies } from 'better-auth/next-js';
import { admin } from 'better-auth/plugins';
import { db } from '@/lib/db';

export const auth = betterAuth({
  database: drizzleAdapter(db(), {
    provider: 'pg', // PostgreSQL provider
  }),
  emailAndPassword: {
    enabled: true, // Enable email/password auth
  },
  socialProviders: {
    google: {
      clientId: process.env.GOOGLE_CLIENT_ID,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET,
    },
    github: {
      clientId: process.env.GITHUB_CLIENT_ID,
      clientSecret: process.env.GITHUB_CLIENT_SECRET,
    },
  },
  session: {
    expiresIn: 60 * 60 * 24 * 30, // 30 days
    updateAge: 60 * 60 * 24, // 24 hours
    cookieCache: {
      enabled: true,
      maxAge: 60 * 5, // 5 minutes
    },
  },
  plugins: [
    nextCookies(),
    admin({
      defaultRole: 'user',
    }),
  ],
});
```

#### 3. Session Helper Function

#### 3.1 SERVER SIDE SESSION MANAGEMENT

The `getCurrentUser` function is already implemented in `lib/auth.ts`:

```typescript
// lib/auth.ts
export async function getCurrentUser() {
  try {
    const session = await auth.api.getSession({
      headers: await headers(), // you need to pass the headers object
    });

    return session?.user || null;
  } catch (error) {
    console.error('Error getting current user:', error);
    return null;
  }
}
```

**Usage in API Routes:**

```typescript
// app/api/protected/route.ts
import { getCurrentUser } from '@/lib/auth';
import { NextRequest } from 'next/server';

export async function GET(request: NextRequest) {
  const user = await getCurrentUser();

  if (!user) {
    return Response.json({ error: 'Unauthorized' }, { status: 401 });
  }

  return Response.json({ user });
}
```

**Usage in Server Components:**

```typescript
// app/dashboard/page.tsx
import { getCurrentUser } from '@/lib/auth';

export default async function Dashboard() {
  const user = await getCurrentUser();

  if (!user) {
    redirect('/login');
  }

  return <div>Welcome {user.name}</div>;
}
```

#### 3.2 CLIENT SIDE SESSION MANAGEMENT

```typescript
// lib/auth-client.ts
import { createAuthClient } from 'better-auth/react';

export const authClient = createAuthClient({});

export const { signIn, signUp, signOut, useSession, getSession } = authClient;
```

**Using useSession Hook (Recommended for Components)**

```typescript
import { authClient } from '@/lib/auth-client';

export function UserProfile() {
  const {
    data: session,
    isPending, // loading state
    error, // error object
    refetch, // refetch the session
  } = authClient.useSession();

  if (isPending) return <div>Loading...</div>;
  if (error) return <div>Error: {error.message}</div>;
  if (!session) return <div>Not authenticated</div>;

  return <div>Welcome {session.user.name}</div>;
}
```

**Using getSession Method (For Non-Hook Contexts)**

```typescript
import { authClient } from '@/lib/auth-client';

const { data: session, error } = await authClient.getSession();
```

#### 3.3 AUTHENTICATION GUARD COMPONENT

Use the AuthGuard component to protect client-side routes and show login UI when user is not authenticated:

```typescript
// components/auth-guard.tsx
'use client';

import React from 'react';
import { authClient } from '@/lib/auth-client';
import { Button } from '@/components/ui/button';

interface AuthGuardProps {
  children: React.ReactNode;
  fallback?: React.ReactNode;
}

export function AuthGuard({ children, fallback }: AuthGuardProps) {
  const { data: session, isPending, error } = authClient.useSession();

  const handleGoogleLogin = async () => {
    try {
      await authClient.signIn.social({
        provider: 'google',
        callbackURL: '/',
      });
    } catch (error) {
      console.error('Failed to sign in with Google', error);
    }
  };

  // Show loading state while checking authentication
  if (isPending) {
    return fallback || <div>Loading...</div>;
  }

  // Handle session errors
  if (error) {
    console.error('Session error:', error);
  }

  // If user is authenticated, render children
  if (session?.user) {
    return <>{children}</>;
  }

  // If user is not authenticated, show login UI
  return (
    <div className="flex items-center justify-center min-h-screen">
      <div className="text-center max-w-md mx-auto p-6">
        <h1 className="text-2xl font-bold mb-4">Authentication Required</h1>
        <p className="text-muted-foreground mb-6">
          You need to be logged in to access this feature. Please login to
          continue.
        </p>
        <Button onClick={handleGoogleLogin} className="w-full">
          Login with Google
        </Button>
      </div>
    </div>
  );
}
```

**For Server Components (Alternative Approach):**

```typescript
// app/protected/page.tsx
import { getCurrentUser } from '@/lib/auth';
import { redirect } from 'next/navigation';

export default async function ProtectedPage() {
  const user = await getCurrentUser();

  if (!user) {
    redirect('/login'); // Redirect to login page
  }

  return <div>Protected content for {user.name}</div>;
}
```

#### Usage Example

```typescript
// app/gallery/page.tsx
import { AuthGuard } from '@/components/auth-guard';
import { GalleryView } from '@/components/gallery-view';

export default function GalleryPage() {
  return (
    <AuthGuard>
      <GalleryView />
    </AuthGuard>
  );
}
```

### Security Layers

1. **UI Layer**: Hide components based on user session
2. **Route Layer**: Middleware for protected routes
3. **API Layer**: Better Auth middleware for request validation (PRIMARY AUTH POINT)
4. **Data Layer**: Pure data operations (NO auth logic)

---
